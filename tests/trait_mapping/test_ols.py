import unittest

import requests_mock

import eva_cttv_pipeline.trait_mapping.ols as ols


class TestGetTraitNames(unittest.TestCase):
    def test_get_label_from_ols(self):
        url = "http://www.ebi.ac.uk/ols/api/terms?iri=http://www.orpha.net/ORDO/Orphanet_199318"
        with requests_mock.mock() as m:
            m.get(url,
                  json={'page': {'totalElements': 2, 'totalPages': 1, 'size': 20, 'number': 0}, '_embedded': {'terms': [{'is_root': False, 'in_subset': None, '_links': {'self': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318'}, 'graph': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/graph'}, 'part_of': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/http%253A%252F%252Fpurl.obolibrary.org%252Fobo%252FBFO_0000050'}, 'has_inheritance': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_C016'}, 'jstree': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/jstree'}, 'parents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/parents'}, 'hierarchicalParents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/hierarchicalParents'}, 'has_AgeOfOnset': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_C017'}, 'ancestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/ancestors'}, 'hierarchicalAncestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/ordo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/hierarchicalAncestors'}}, 'obo_id': 'Orphanet:199318', 'obo_xref': [{'id': 'C2677613', 'url': None, 'database': 'UMLS', 'description': 'E (exact mapping (the terms and the concepts are equivalent))'}, {'id': 'Q93.5', 'url': None, 'database': 'ICD-10', 'description': 'NTBT (narrower term maps to a broader term)'}, {'id': 'Q93.5', 'url': None, 'database': 'ICD-10', 'description': 'Attributed'}, {'id': '612001', 'url': 'http://omim.org/entry/612001', 'database': 'OMIM', 'description': 'E (exact mapping (the terms and the concepts are equivalent))'}], 'iri': 'http://www.orpha.net/ORDO/Orphanet_199318', 'obo_synonym': None, 'is_defining_ontology': True, 'ontology_name': 'ordo', 'is_obsolete': False, 'synonyms': ['Monosomy 15q13.3', 'Del(15)(q13.3)'], 'ontology_iri': 'http://www.orpha.net/ontology/orphanet.owl', 'label': '15q13.3 microdeletion syndrome', 'description': ['15q13.3 microdeletion (microdel15q13.3) syndrome is characterized by a wide spectrum of neurodevelopmental disorders with no or subtle dysmorphic features.'], 'obo_definition_citation': None, 'has_children': False, 'ontology_prefix': 'ORDO', 'annotation': {'hasDbXref': ['ICD-10:Q93.5', 'OMIM:612001', 'UMLS:C2677613'], 'definition_citation': ['orphanet']}, 'short_form': 'Orphanet_199318', 'term_replaced_by': None}, {'is_root': False, 'in_subset': None, '_links': {'self': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318'}, 'graph': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/graph'}, 'jstree': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/jstree'}, 'parents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/parents'}, 'hierarchicalParents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/hierarchicalParents'}, 'ancestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/ancestors'}, 'hierarchicalAncestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_199318/hierarchicalAncestors'}}, 'obo_id': 'Orphanet:199318', 'obo_xref': None, 'iri': 'http://www.orpha.net/ORDO/Orphanet_199318', 'obo_synonym': None, 'is_defining_ontology': False, 'ontology_name': 'efo', 'is_obsolete': False, 'synonyms': ['Monosomy 15q13.3', 'Del(15)(q13.3)'], 'ontology_iri': 'http://www.ebi.ac.uk/efo/efo.owl', 'label': '15q13.3 microdeletion syndrome', 'description': ['15q13.3 microdeletion (microdel15q13.3) syndrome is characterized by a wide spectrum of neurodevelopmental disorders with no or subtle dysmorphic features.'], 'obo_definition_citation': None, 'has_children': False, 'ontology_prefix': 'EFO', 'annotation': {'OMIM_definition_citation': ['OMIM:612001'], 'definition_citation': ['orphanet'], 'ICD10_definition_citation': ['ICD10:Q93.5']}, 'short_form': 'Orphanet_199318', 'term_replaced_by': None}]}, '_links': {'self': {'href': 'http://www.ebi.ac.uk/ols/api/terms'}}})

            self.assertEqual(ols.get_label_from_ols(url),
                             '15q13.3 microdeletion syndrome')


class TestIsCurrentAndInEfo(unittest.TestCase):
    def test_is_current_and_in_efo(self):

        with requests_mock.mock() as m:
            url = "http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425"
            m.get(url,
                  json={'is_root': False, 'in_subset': None, '_links': {'self': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425'}, 'graph': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/graph'}, 'jstree': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/jstree'}, 'parents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/parents'}, 'hierarchicalParents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/hierarchicalParents'}, 'ancestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/ancestors'}, 'hierarchicalAncestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/hierarchicalAncestors'}}, 'obo_id': 'Orphanet:425', 'obo_xref': None, 'iri': 'http://www.orpha.net/ORDO/Orphanet_425', 'obo_synonym': None, 'is_defining_ontology': False, 'ontology_name': 'efo', 'is_obsolete': False, 'synonyms': ['ApoA-I deficiency', 'Familial hypoalphalipoproteinemia', 'Familial apoA-I deficiency'], 'ontology_iri': 'http://www.ebi.ac.uk/efo/efo.owl', 'label': 'Apolipoprotein A-I deficiency', 'description': ['Apolipoprotein AI (Apo A-I) deficiency is a rare lipoprotein metabolism disorder characterized biochemically by complete absence of apolipoprotein AI and extremely low plasma high density lipoprotein (HDL) cholesterol, and clinically by corneal opacities and xanthomas complicated with premature coronary heart disease (CHD).'], 'obo_definition_citation': None, 'has_children': False, 'ontology_prefix': 'EFO', 'annotation': {'MedDRA_definition_citation': ['MedDRA:10065133'], 'OMIM_definition_citation': ['OMIM:604091'], 'MSH_definition_citation': ['MSH:D052456'], 'definition_citation': ['orphanet'], 'ICD10_definition_citation': ['ICD10:E78.6'], 'UMLS_definition_citation': ['UMLS:C1704429', 'UMLS:C0342898']}, 'short_form': 'Orphanet_425', 'term_replaced_by': None})

            self.assertEqual(ols.is_current_and_in_efo("http://www.orpha.net/ORDO/Orphanet_425"),
                             True)


class TestIsInEfo(unittest.TestCase):
    def test_is_in_efo(self):
        with requests_mock.mock() as m:
            url = "http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425"
            m.get(url,
                  json={'is_root': False, 'in_subset': None, '_links': {'self': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425'}, 'graph': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/graph'}, 'jstree': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/jstree'}, 'parents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/parents'}, 'hierarchicalParents': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/hierarchicalParents'}, 'ancestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/ancestors'}, 'hierarchicalAncestors': {'href': 'http://www.ebi.ac.uk/ols/api/ontologies/efo/terms/http%253A%252F%252Fwww.orpha.net%252FORDO%252FOrphanet_425/hierarchicalAncestors'}}, 'obo_id': 'Orphanet:425', 'obo_xref': None, 'iri': 'http://www.orpha.net/ORDO/Orphanet_425', 'obo_synonym': None, 'is_defining_ontology': False, 'ontology_name': 'efo', 'is_obsolete': False, 'synonyms': ['ApoA-I deficiency', 'Familial hypoalphalipoproteinemia', 'Familial apoA-I deficiency'], 'ontology_iri': 'http://www.ebi.ac.uk/efo/efo.owl', 'label': 'Apolipoprotein A-I deficiency', 'description': ['Apolipoprotein AI (Apo A-I) deficiency is a rare lipoprotein metabolism disorder characterized biochemically by complete absence of apolipoprotein AI and extremely low plasma high density lipoprotein (HDL) cholesterol, and clinically by corneal opacities and xanthomas complicated with premature coronary heart disease (CHD).'], 'obo_definition_citation': None, 'has_children': False, 'ontology_prefix': 'EFO', 'annotation': {'MedDRA_definition_citation': ['MedDRA:10065133'], 'OMIM_definition_citation': ['OMIM:604091'], 'MSH_definition_citation': ['MSH:D052456'], 'definition_citation': ['orphanet'], 'ICD10_definition_citation': ['ICD10:E78.6'], 'UMLS_definition_citation': ['UMLS:C1704429', 'UMLS:C0342898']}, 'short_form': 'Orphanet_425', 'term_replaced_by': None})

            self.assertEqual(ols.is_in_efo("http://www.orpha.net/ORDO/Orphanet_425"),
                             True)










